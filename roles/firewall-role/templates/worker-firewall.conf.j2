#!/usr/sbin/nft -f

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0;

        # Allow loopback traffic
        iif "lo" accept

        # Allow established and related connections
        ct state established,related accept

        # Allow SSH 
        tcp dport {{sshd_port}} ip saddr {{bastion_private_ip}} accept

        # Prometheus Export Port
        tcp dport {{prometheus_port}} ip saddr {{bastion_private_ip}} accept

        # Prometheus Metric Port
        tcp dport 9100 ip saddr {{node_CDIR}} accept
 
        # Nginx ingress Port
        tcp dport {{nginx_ingress_port}} accept
        
        # ElasticSearch Port
        tcp dport {{elasticsearch_port}} ip saddr {{bastion_private_ip}} accept

        # Kubelet port
        tcp dport 10250 ip saddr {{master_private_ip}} accept

        # CNI overlay (VXLAN)
        udp dport 4789 ip saddr {{node_CDIR}} accept 

        # Allow pings from Bastion and Master
        ip protocol icmp ip saddr { {{master_private_ip}}, {{bastion_private_ip}} } accept      

        # Drop everything else
        counter drop
    }

    chain output {
        type filter hook output priority 0;
        accept
    }
}
